<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FanVerse - Client Int√©gr√© Blockchain</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; color: #333; }
        #app-container { display: flex; width: 95%; max-width: 1400px; background-color: #fff; box-shadow: 0 0 15px rgba(0, 0, 0, 0.1); border-radius: 8px; overflow: hidden; margin-top: 20px; flex-wrap: wrap; }
        #left-panel, #center-panel, #right-panel { padding: 20px; box-sizing: border-box; border-right: 1px solid #eee; min-height: 800px; }
        #left-panel { flex: 1; min-width: 250px; max-width: 300px; display: flex; flex-direction: column; gap: 15px; }
        #center-panel { flex: 2; min-width: 400px; display: flex; flex-direction: column; gap: 20px; border-right: 1px solid #eee; }
        #right-panel { flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 20px; border-right: none; }
        h2 { font-size: 1.4em; margin-bottom: 15px; color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        button { padding: 10px 15px; border: none; border-radius: 5px; background-color: #007bff; color: white; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        input, textarea { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .chat-messages { height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background-color: #f9f9f9; border-radius: 5px; }
        .message { margin-bottom: 10px; }
        .message strong { color: #007bff; }
        .emotion-button { margin: 5px; padding: 10px 15px; border-radius: 5px; cursor: pointer; background-color: #6c757d; color: white; }
        .emotion-button:hover { background-color: #5a6268; }
        .action-card { background: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .action-card h3 { margin: 0 0 10px 0; font-size: 1.1em; }
        .action-card .votes { margin: 10px 0; font-size: 1.1em; }
        .action-card .votes-yes { color: #28a745; font-weight: bold; margin-right: 15px; }
        .action-card .votes-no { color: #dc3545; font-weight: bold; }
        .action-card .result { font-weight: bold; font-size: 1.2em; padding: 10px; border-radius: 5px; text-align: center; margin-top: 10px; }
        .result.success { background-color: #e9f7ef; color: #28a745; }
        .result.failed { background-color: #fdeded; color: #dc3545; }
        #bet-info { font-weight: bold; }
        
        /* Nouveaux styles blockchain */
        .blockchain-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .blockchain-section h3 { color: white; border-bottom: 2px solid rgba(255,255,255,0.3); }
        .wallet-info { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 0.9em; }
        .balance-display { font-size: 1.2em; font-weight: bold; margin: 10px 0; }
        .blockchain-status { padding: 5px 10px; border-radius: 15px; font-size: 0.8em; margin: 5px 0; display: inline-block; }
        .blockchain-status.connected { background: #28a745; color: white; }
        .blockchain-status.disconnected { background: #dc3545; color: white; }
        .bet-mode { margin: 10px 0; }
        .bet-mode label { display: block; margin: 5px 0; cursor: pointer; }
        .bet-type-blockchain { background: linear-gradient(45deg, #667eea, #764ba2); }
        .bet-type-backend { background: #6c757d; }
        .nft-card { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; margin: 5px 0; font-size: 0.9em; }
        
        /* Styles pour les options de pari blockchain */
        .blockchain-bet-option { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            margin: 5px; 
            padding: 12px 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .blockchain-bet-option:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .blockchain-bet-option.selected {
            border-color: #ff6b35;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
        }
        .blockchain-options-container {
            display: none;
            margin: 10px 0;
        }
        .blockchain-amount-input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            width: 100%;
        }
        .blockchain-amount-input::placeholder { color: rgba(255,255,255,0.7); }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Left Panel -->
        <div id="left-panel">
            <div id="login-section">
                <h2>Connexion</h2>
                <input type="text" id="userIdInput" placeholder="Entrez votre ID utilisateur">
                <button id="loginButton">Se connecter</button>
                <p id="loginMessage" style="color: red;"></p>
            </div>
            
            <div id="user-info" style="display: none;">
                <h2>Bienvenue, <span id="displayUserId"></span></h2>
                <p>Solde Backend : <span id="chzBalance">0</span> CHZ</p>
            </div>
            
            <!-- ‚ú® SECTION BLOCKCHAIN AM√âLIOR√âE -->
            <div id="blockchain-section" class="blockchain-section" style="display: none;">
                <h3>üîó Wallet Blockchain</h3>
                
                <div class="blockchain-status disconnected" id="blockchain-status">
                    ‚õìÔ∏è Blockchain d√©connect√©e
                </div>
                
                <div id="wallet-connection" style="display: block;">
                    <button id="connect-wallet-btn" style="background: linear-gradient(45deg, #ff6b35, #f7931e);">
                        Connecter MetaMask
                    </button>
                </div>
                
                <div id="wallet-info" style="display: none;">
                    <div class="wallet-info">
                        <strong>Adresse:</strong><br>
                        <span id="wallet-address" style="font-family: monospace; font-size: 0.8em;"></span>
                    </div>
                    <div class="balance-display">
                        üí∞ <span id="wallet-balance">0</span> CHZ
                    </div>
                    <button id="disconnect-wallet-btn" style="background: #dc3545; font-size: 0.8em;">
                        D√©connecter
                    </button>
                </div>
            </div>

            <!-- Section √©motions existante -->
            <div id="emotion-section" style="display: none;">
                <h2>√âmotions</h2>
                <button class="emotion-button" data-emotion="anger">Col√®re üò°</button>
                <button class="emotion-button" data-emotion="surprise">Surprise üòÆ</button>
                <button class="emotion-button" data-emotion="joy">Joie üòÇ</button>
                <button class="emotion-button" data-emotion="hype">Hype üî•</button>
                <button class="emotion-button" data-emotion="fear">Peur üò®</button>
                <button class="emotion-button" data-emotion="sadness">Tristesse üò¢</button>
                <div>
                    <p>Col√®re : <span id="angerCount">0</span></p>
                    <p>Surprise : <span id="surpriseCount">0</span></p>
                    <p>Joie : <span id="joyCount">0</span></p>
                    <p>Hype : <span id="hypeCount">0</span></p>
                    <p>Peur : <span id="fearCount">0</span></p>
                    <p>Tristesse : <span id="sadnessCount">0</span></p>
                </div>
            </div>
        </div>

        <!-- Center Panel -->
        <div id="center-panel">
            <div id="bet-section" style="display: none;">
                <h2>Paris <span id="bet-timer" style="color: #dc3545; margin-left: 15px;"></span></h2>
                
                <!-- ‚ú® MODE DE PARI AM√âLIOR√â -->
                <div class="bet-mode">
                    <label><input type="radio" name="bet-mode" value="backend" checked> üíª Pari Backend (solde interne)</label>
                    <label><input type="radio" name="bet-mode" value="blockchain" id="blockchain-mode" disabled> ‚õìÔ∏è Pari Blockchain (MetaMask + CHZ r√©els)</label>
                </div>
                
                <p id="bet-question">Aucun pari en cours.</p>
                
                <!-- Options du pari backend (existant) -->
                <div id="backend-bet-container">
                    <div id="bet-options"></div>
                    <input type="number" id="bet-amount" placeholder="Montant √† parier (CHZ)">
                </div>
                
                <!-- ‚ú® NOUVELLES OPTIONS BLOCKCHAIN -->
                <div id="blockchain-bet-container" class="blockchain-section" style="display: none;">
                    <h4 style="color: white; margin: 10px 0;">üé≤ Pariez avec vos CHZ via MetaMask</h4>
                    
                    <!-- Options de pari blockchain -->
                    <div id="blockchain-bet-options" class="blockchain-options-container"></div>
                    
                    <!-- Montant du pari blockchain -->
                    <input type="number" id="blockchain-bet-amount" class="blockchain-amount-input" 
                           placeholder="Montant en CHZ (ex: 0.1)" step="0.01" min="0.01">
                    
                    <!-- Bouton de pari -->
                    <button id="place-blockchain-bet-btn" class="bet-type-blockchain" disabled style="width: 100%;">
                        üöÄ Placer le pari blockchain
                    </button>
                    
                    <!-- Statut du pari -->
                    <div id="blockchain-bet-status" style="margin-top: 10px; font-size: 0.9em;"></div>
                </div>
                
                <p id="bet-info"></p>
            </div>
            
            <div id="chat-section" style="display: none;">
                <h2>Chat G√©n√©ral</h2>
                <div class="chat-messages" id="chat-messages"></div>
                <input type="text" id="chat-input" placeholder="Entrez votre message">
                <button id="send-chat-button">Envoyer</button>
            </div>
        </div>

        <!-- Right Panel -->
        <div id="right-panel">
            <div id="action-section" style="display: none;">
                <h2>Proposer une Action</h2>
                <input type="text" id="action-input" placeholder="Ex: Chanter la marseillaise">
                <button id="propose-action-button">Proposer</button>
                <hr style="margin: 20px 0;">
                <h2>Actions en Cours</h2>
                <div id="active-actions-container"><p>Aucune action en cours.</p></div>
                <hr style="margin: 20px 0;">
                <h2>Actions Termin√©es</h2>
                <div id="past-actions-container"></div>
            </div>
            
            <!-- ‚ú® SECTION MES NFTs -->
            <div id="nft-section" class="blockchain-section" style="display: none;">
                <h3>üé® Mes NFTs</h3>
                <button id="load-my-nfts" style="background: #6f42c1;">Charger mes NFTs</button>
                <div id="my-nfts-container"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io('http://localhost:3000');

        // Configuration blockchain
        const TESTNET_CONFIG = {
            chainId: '0x15b32',
            chainName: 'Chiliz Spicy Testnet',
            nativeCurrency: { name: 'Chiliz', symbol: 'CHZ', decimals: 18 },
            rpcUrls: ['https://spicy-rpc.chiliz.com/'],
            blockExplorerUrls: ['https://testnet.chiliscan.com/']
        };

        // Variables blockchain
        let provider = null;
        let signer = null;
        let walletAddress = null;
        let blockchainConnected = false;

        // Variables de pari
        let currentBetData = null;
        let selectedBlockchainOption = null;

        // --- DOM Elements existants ---
        const loginSection = document.getElementById('login-section');
        const loginButton = document.getElementById('loginButton');
        const userIdInput = document.getElementById('userIdInput');
        const loginMessage = document.getElementById('loginMessage');
        const userInfo = document.getElementById('user-info');
        const displayUserId = document.getElementById('displayUserId');
        const chzBalance = document.getElementById('chzBalance');
        const betQuestion = document.getElementById('bet-question');
        const betOptionsContainer = document.getElementById('bet-options');
        const betAmountInput = document.getElementById('bet-amount');
        const betInfo = document.getElementById('bet-info');
        const betTimerSpan = document.getElementById('bet-timer');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendChatButton = document.getElementById('send-chat-button');

        // --- Nouveaux √©l√©ments blockchain ---
        const connectWalletBtn = document.getElementById('connect-wallet-btn');
        const disconnectWalletBtn = document.getElementById('disconnect-wallet-btn');
        const walletInfo = document.getElementById('wallet-info');
        const walletConnection = document.getElementById('wallet-connection');
        const walletAddressSpan = document.getElementById('wallet-address');
        const walletBalanceSpan = document.getElementById('wallet-balance');
        const blockchainStatus = document.getElementById('blockchain-status');
        const blockchainModeRadio = document.getElementById('blockchain-mode');
        const loadMyNFTsBtn = document.getElementById('load-my-nfts');
        const myNFTsContainer = document.getElementById('my-nfts-container');
        
        // Nouveaux √©l√©ments pour les paris blockchain
        const backendBetContainer = document.getElementById('backend-bet-container');
        const blockchainBetContainer = document.getElementById('blockchain-bet-container');
        const blockchainBetOptions = document.getElementById('blockchain-bet-options');
        const blockchainBetAmount = document.getElementById('blockchain-bet-amount');
        const placeBlockchainBetBtn = document.getElementById('place-blockchain-bet-btn');
        const blockchainBetStatus = document.getElementById('blockchain-bet-status');
        
        let betTimerInterval = null;

        // --- FONCTIONS BLOCKCHAIN ---
        
        // Connexion MetaMask
        connectWalletBtn.addEventListener('click', async () => {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('MetaMask non d√©tect√©! Veuillez l\'installer.');
                    return;
                }

                console.log('üîÑ Connexion √† MetaMask...');

                // Changer vers le testnet
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: TESTNET_CONFIG.chainId }]
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [TESTNET_CONFIG]
                        });
                    }
                }

                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });

                walletAddress = accounts[0];
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();

                // Obtenir la balance
                const balance = await provider.getBalance(walletAddress);
                const balanceInCHZ = ethers.utils.formatEther(balance);

                // Mettre √† jour l'affichage
                walletConnection.style.display = 'none';
                walletInfo.style.display = 'block';
                walletAddressSpan.textContent = `${walletAddress.substring(0, 8)}...${walletAddress.substring(walletAddress.length - 6)}`;
                walletBalanceSpan.textContent = parseFloat(balanceInCHZ).toFixed(4);
                blockchainStatus.textContent = '‚úÖ Blockchain connect√©e';
                blockchainStatus.className = 'blockchain-status connected';
                
                // Activer le mode blockchain
                blockchainModeRadio.disabled = false;
                placeBlockchainBetBtn.disabled = false;
                
                // Authentifier avec le backend
                if (socket && socket.userId) {
                    socket.emit('authenticate', { 
                        userId: socket.userId, 
                        walletAddress: walletAddress 
                    });
                }

                blockchainConnected = true;
                console.log(`‚úÖ MetaMask connect√©: ${walletAddress}`);

                // Activer les options blockchain si un pari est en cours
                if (currentBetData) {
                    setupBlockchainBetOptions(currentBetData);
                }

            } catch (error) {
                console.error('‚ùå Erreur connexion MetaMask:', error);
                alert(`Erreur: ${error.message}`);
            }
        });

        // D√©connexion wallet
        disconnectWalletBtn.addEventListener('click', () => {
            walletAddress = null;
            provider = null;
            signer = null;
            blockchainConnected = false;

            walletConnection.style.display = 'block';
            walletInfo.style.display = 'none';
            blockchainStatus.textContent = '‚õìÔ∏è Blockchain d√©connect√©e';
            blockchainStatus.className = 'blockchain-status disconnected';
            
            blockchainModeRadio.disabled = true;
            placeBlockchainBetBtn.disabled = true;
            
            // Revenir au mode backend
            document.querySelector('input[name="bet-mode"][value="backend"]').checked = true;
            toggleBetMode();
            
            console.log('üëã Wallet d√©connect√©');
        });

        // Basculer entre mode backend et blockchain
        document.querySelectorAll('input[name="bet-mode"]').forEach(radio => {
            radio.addEventListener('change', toggleBetMode);
        });

        function toggleBetMode() {
            const isBlockchainMode = document.querySelector('input[name="bet-mode"]:checked').value === 'blockchain';
            
            if (isBlockchainMode) {
                backendBetContainer.style.display = 'none';
                blockchainBetContainer.style.display = 'block';
                betInfo.textContent = 'üîó Mode blockchain activ√© - Pariez avec vos CHZ r√©els!';
                betInfo.style.color = '#667eea';
                
                // Configurer les options si un pari est en cours
                if (currentBetData && blockchainConnected) {
                    setupBlockchainBetOptions(currentBetData);
                }
            } else {
                backendBetContainer.style.display = 'block';
                blockchainBetContainer.style.display = 'none';
                betInfo.textContent = '';
            }
        }

        // ‚ú® NOUVELLE FONCTION : Configuration des options blockchain
        function setupBlockchainBetOptions(betData) {
            if (!blockchainConnected) return;
            
            currentBetData = betData;
            blockchainBetOptions.innerHTML = '';
            blockchainBetOptions.style.display = 'block';
            selectedBlockchainOption = null;
            
            betData.options.forEach((optionText, index) => {
                const optionBtn = document.createElement('button');
                optionBtn.className = 'blockchain-bet-option';
                optionBtn.textContent = `${index + 1}. ${optionText}`;
                optionBtn.onclick = () => selectBlockchainOption(index, optionText, optionBtn);
                blockchainBetOptions.appendChild(optionBtn);
            });
            
            blockchainBetStatus.innerHTML = `
                <div style="color: #4ade80;">üìä Choisissez votre option et montant</div>
                <div style="color: rgba(255,255,255,0.8); font-size: 0.8em;">
                    Les paris se font directement sur la blockchain avec vos CHZ
                </div>
            `;
        }

        // S√©lection d'une option blockchain
        function selectBlockchainOption(index, optionText, buttonElement) {
            // D√©s√©lectionner les autres options
            document.querySelectorAll('.blockchain-bet-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // S√©lectionner cette option
            buttonElement.classList.add('selected');
            selectedBlockchainOption = { index, text: optionText };
            
            blockchainBetStatus.innerHTML = `
                <div style="color: #4ade80;">‚úÖ Option s√©lectionn√©e: ${optionText}</div>
                <div style="color: rgba(255,255,255,0.8); font-size: 0.8em;">
                    Entrez le montant et cliquez sur "Placer le pari"
                </div>
            `;
            
            // V√©rifier si on peut activer le bouton
            checkBlockchainBetReady();
        }

        // V√©rifier si le pari blockchain est pr√™t
        function checkBlockchainBetReady() {
            const amount = parseFloat(blockchainBetAmount.value);
            const canBet = selectedBlockchainOption && 
                          amount > 0 && 
                          blockchainConnected && 
                          currentBetData;
                          
            placeBlockchainBetBtn.disabled = !canBet;
        }

        // √âcouter les changements de montant
        blockchainBetAmount.addEventListener('input', checkBlockchainBetReady);

        // ‚ú® PLACER UN PARI BLOCKCHAIN SUR LES M√äMES OPTIONS QUE LE BACKEND
        placeBlockchainBetBtn.addEventListener('click', async () => {
            try {
                if (!selectedBlockchainOption) {
                    alert('Veuillez s√©lectionner une option');
                    return;
                }

                const amount = parseFloat(blockchainBetAmount.value);
                if (!amount || amount <= 0) {
                    alert('Veuillez entrer un montant valide');
                    return;
                }

                if (!walletAddress) {
                    alert('Connectez votre wallet d\'abord');
                    return;
                }

                console.log(`üé≤ Pari blockchain: "${selectedBlockchainOption.text}" pour ${amount} CHZ`);
                
                // Mettre √† jour le statut
                blockchainBetStatus.innerHTML = `
                    <div style="color: #ff9800;">‚è≥ Placement du pari en cours...</div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.8em;">
                        Transaction en attente de confirmation...
                    </div>
                `;
                placeBlockchainBetBtn.disabled = true;

                // Utiliser l'adresse du contrat EmotionBet
                const emotionBetAddress = '0xA21a8923d128bf0CA1DdeD6E1350853389a13fAc';
                const emotionBetABI = [
                    "function placeBet(string description) payable"
                ];

                // Description compl√®te incluant l'option choisie
                const betDescription = `${currentBetData.question} - R√©ponse: ${selectedBlockchainOption.text}`;

                const contract = new ethers.Contract(emotionBetAddress, emotionBetABI, signer);
                const tx = await contract.placeBet(betDescription, {
                    value: ethers.utils.parseEther(amount.toString())
                });

                blockchainBetStatus.innerHTML = `
                    <div style="color: #ff9800;">üì§ Transaction envoy√©e</div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.8em;">
                        Hash: ${tx.hash.substring(0, 10)}...
                    </div>
                `;

                const receipt = await tx.wait();
                
                blockchainBetStatus.innerHTML = `
                    <div style="color: #4ade80;">‚úÖ Pari plac√© avec succ√®s!</div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.8em;">
                        Block: ${receipt.blockNumber} | Option: ${selectedBlockchainOption.text}
                    </div>
                `;
                
                // Vider les champs
                blockchainBetAmount.value = '';
                selectedBlockchainOption = null;
                
                // D√©s√©lectionner les options
                document.querySelectorAll('.blockchain-bet-option').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // Rafra√Æchir la balance
                const balance = await provider.getBalance(walletAddress);
                walletBalanceSpan.textContent = parseFloat(ethers.utils.formatEther(balance)).toFixed(4);

                console.log(`‚úÖ Pari blockchain plac√©: ${betDescription}`);

            } catch (error) {
                console.error('‚ùå Erreur placement pari:', error);
                
                let errorMsg = '‚ùå Erreur lors du placement du pari';
                if (error.message.includes('Pari ferme')) {
                    errorMsg = '‚ùå Le contrat de paris est ferm√©';
                } else if (error.message.includes('insufficient funds')) {
                    errorMsg = '‚ùå Fonds insuffisants';
                } else if (error.message.includes('user rejected')) {
                    errorMsg = '‚ùå Transaction annul√©e par l\'utilisateur';
                }
                
                blockchainBetStatus.innerHTML = `
                    <div style="color: #f87171;">${errorMsg}</div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.8em;">
                        R√©essayez ou v√©rifiez votre solde
                    </div>
                `;
                
                placeBlockchainBetBtn.disabled = false;
            }
        });

        // Charger mes NFTs
        loadMyNFTsBtn.addEventListener('click', () => {
            if (walletAddress && socket) {
                socket.emit('get_my_nfts');
                myNFTsContainer.innerHTML = '<p>‚è≥ Chargement des NFTs...</p>';
            } else {
                alert('Connectez votre wallet d\'abord');
            }
        });

        // --- √âV√âNEMENTS SOCKET BLOCKCHAIN ---
        
        socket.on('blockchain_status', (data) => {
            if (data.connected) {
                console.log('‚úÖ Backend blockchain connect√©');
            }
        });

        socket.on('blockchain_bet_placed', (data) => {
            console.log(`üé≤ Nouveau pari blockchain: ${data.description}`);
        });

        socket.on('blockchain_nft_minted', (data) => {
            console.log(`üé® NFT mint√©: ${data.rarity}`);
            if (data.to.toLowerCase() === walletAddress?.toLowerCase()) {
                loadMyNFTsBtn.click();
            }
        });

        socket.on('my_nfts', (data) => {
            displayMyNFTs(data.nfts);
        });

        socket.on('nfts_error', (data) => {
            myNFTsContainer.innerHTML = `<p style="color: #dc3545;">‚ùå ${data.message}</p>`;
        });

        function displayMyNFTs(nfts) {
            if (nfts.length === 0) {
                myNFTsContainer.innerHTML = '<p>Aucun NFT trouv√©</p>';
                return;
            }

            let html = '';
            nfts.forEach(nft => {
                const rarityColor = {
                    'Common': '#28a745',
                    'Rare': '#007bff',
                    'Epic': '#6f42c1',
                    'Legendary': '#ffc107'
                }[nft.rarity] || '#6c757d';

                html += `
                    <div class="nft-card">
                        <strong>${nft.eventName}</strong><br>
                        Raret√©: <span style="color: ${rarityColor}">${nft.rarity}</span><br>
                        Date: ${nft.eventDate}<br>
                        Type: ${nft.eventType}<br>
                        ID: #${nft.id}
                    </div>
                `;
            });
            myNFTsContainer.innerHTML = html;
        }

        // --- CODE EXISTANT (LOGIN, CHAT, √âMOTIONS, PARIS BACKEND, ACTIONS) ---
        
        loginButton.addEventListener('click', () => {
            const userId = userIdInput.value.trim();
            if (userId) socket.emit('authenticate', { userId, walletAddress });
            else loginMessage.textContent = 'Veuillez entrer un ID utilisateur.';
        });

        socket.on('authenticated', (data) => {
            loginSection.style.display = 'none';
            const sectionsToShow = ['user-info', 'emotion-section', 'bet-section', 'chat-section', 'action-section', 'blockchain-section', 'nft-section'];
            sectionsToShow.forEach(id => document.getElementById(id).style.display = 'block');
            
            displayUserId.textContent = data.userId;
            chzBalance.textContent = data.chzBalance.toFixed(2);
            
            socket.userId = data.userId;
        });

        socket.on('login_error', (data) => { loginMessage.textContent = data.message; });

        // --- CHAT ---
        sendChatButton.addEventListener('click', () => {
            const message = chatInput.value.trim();
            if (message) {
                socket.emit('send_message', { message });
                chatInput.value = '';
            }
        });
        socket.on('new_message', (msg) => {
            const p = document.createElement('p');
            p.classList.add('message');
            p.innerHTML = `<strong>${msg.userId}</strong>: ${msg.message}`;
            chatMessages.appendChild(p);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        // --- √âMOTIONS ---
        document.querySelectorAll('.emotion-button').forEach(button => {
            button.addEventListener('click', () => {
                socket.emit('send_emotion', { emotionType: button.dataset.emotion });
            });
        });

        socket.on('emotion_update', (data) => {
            document.getElementById('angerCount').textContent = data.anger || 0;
            document.getElementById('surpriseCount').textContent = data.surprise || 0;
            document.getElementById('joyCount').textContent = data.joy || 0;
            document.getElementById('hypeCount').textContent = data.hype || 0;
            document.getElementById('fearCount').textContent = data.fear || 0;
            document.getElementById('sadnessCount').textContent = data.sadness || 0;
        });

        // --- PARIS BACKEND ET BLOCKCHAIN (code modifi√©) ---
        socket.on('new_bet', (bet) => {
            currentBetData = bet; // Stocker les donn√©es du pari
            
            betQuestion.textContent = bet.question;
            betOptionsContainer.innerHTML = '';
            betInfo.textContent = '';
            betAmountInput.value = '';
            betAmountInput.disabled = false;

            if (betTimerInterval) clearInterval(betTimerInterval);
            const endTime = Date.now() + bet.duration;
            
            betTimerInterval = setInterval(() => {
                const remaining = endTime - Date.now();
                if (remaining <= 0) {
                    clearInterval(betTimerInterval);
                    betTimerSpan.textContent = "00:00";
                    return;
                }
                const minutes = Math.floor((remaining / 1000) / 60);
                const seconds = Math.floor((remaining / 1000) % 60);
                betTimerSpan.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);

            // Options backend (existant)
            bet.options.forEach((optionText, index) => {
                const button = document.createElement('button');
                button.textContent = optionText;
                button.onclick = () => placeBet(index);
                betOptionsContainer.appendChild(button);
            });
            
            // ‚ú® Configurer les options blockchain si le mode est activ√©
            if (blockchainConnected && document.querySelector('input[name="bet-mode"]:checked').value === 'blockchain') {
                setupBlockchainBetOptions(bet);
            }
        });

        function placeBet(optionIndex) {
            // Ne fonctionne qu'en mode backend
            if (document.querySelector('input[name="bet-mode"]:checked').value === 'blockchain') {
                betInfo.textContent = '‚ö†Ô∏è Utilisez la section blockchain pour parier';
                betInfo.style.color = '#ff9800';
                return;
            }

            const amount = parseInt(betAmountInput.value, 10);
            if (isNaN(amount) || amount <= 0) {
                betInfo.style.color = 'red';
                betInfo.textContent = 'Veuillez entrer un montant valide.';
                return;
            }
            socket.emit('place_bet', { optionIndex: optionIndex, amount: amount });
        }

        socket.on('bet_accepted', (data) => {
            betInfo.style.color = 'green';
            betInfo.textContent = data.message;
            chzBalance.textContent = data.newBalance.toFixed(2);
            betOptionsContainer.innerHTML = '<p><i>Pari enregistr√©. Bonne chance !</i></p>';
            betAmountInput.disabled = true;
        });

        socket.on('bet_error', (data) => {
            betInfo.style.color = 'red';
            betInfo.textContent = data.message;
        });

        socket.on('bet_closed', (data) => {
            if (betTimerInterval) clearInterval(betTimerInterval);
            betTimerSpan.textContent = "";
            betInfo.style.color = '#333';
            betInfo.textContent = data.message;
            betAmountInput.disabled = true;
            if (!betOptionsContainer.querySelector('p')) {
                betOptionsContainer.innerHTML = '';
            }
            
            // D√©sactiver les options blockchain aussi
            blockchainBetOptions.style.display = 'none';
            placeBlockchainBetBtn.disabled = true;
            blockchainBetStatus.innerHTML = `
                <div style="color: #f87171;">‚è∞ Paris ferm√©s</div>
                <div style="color: rgba(255,255,255,0.8); font-size: 0.8em;">
                    Attendez le prochain pari...
                </div>
            `;
        });

        socket.on('bet_result', (data) => {
            if (data.winnings > 0) {
                betInfo.style.color = 'green';
            } else {
                betInfo.style.color = '#E85B0C';
            }
            betInfo.textContent = data.message;
            chzBalance.textContent = data.newBalance.toFixed(2);
            betQuestion.textContent = `L'option gagnante √©tait : ${data.winningOption}`;
            betOptionsContainer.innerHTML = '<p><i>Prochain pari dans quelques instants...</i></p>';
            
            // Afficher le r√©sultat pour les paris blockchain aussi
            blockchainBetStatus.innerHTML = `
                <div style="color: #4ade80;">üèÜ R√©sultat: ${data.winningOption}</div>
                <div style="color: rgba(255,255,255,0.8); font-size: 0.8em;">
                    Prochain pari bient√¥t disponible...
                </div>
            `;
        });

        // --- ACTIONS COLLECTIVES (code existant inchang√©) ---
        const actionInput = document.getElementById('action-input');
        const proposeActionButton = document.getElementById('propose-action-button');
        const activeActionsContainer = document.getElementById('active-actions-container');
        const pastActionsContainer = document.getElementById('past-actions-container');

        proposeActionButton.addEventListener('click', () => {
            const actionText = actionInput.value.trim();
            if (actionText) {
                socket.emit('create_action', { action: actionText });
                actionInput.value = '';
            }
        });
        
        socket.on('new_action', (action) => {
            if (activeActionsContainer.querySelector('p')) {
                activeActionsContainer.innerHTML = ''; 
            }
            displayNewAction(action);
        });

        socket.on('action_update', (updatedAction) => {
            updateActionDisplay(updatedAction);
        });

        socket.on('action_result', (result) => {
            finalizeActionDisplay(result);
        });
        
        socket.on('action_error', (error) => {
            alert(`Erreur d'action: ${error.message}`);
        });

        function displayNewAction(action) {
            const actionCard = document.createElement('div');
            actionCard.className = 'action-card';
            actionCard.id = `action-${action._id}`;
            actionCard.innerHTML = `
                <h3>${action.action}</h3>
                <p>Propos√© par : ${action.proposer}</p>
                <div class="votes">
                    <span class="votes-yes">OUI : ${action.yesVotes}</span>
                    <span class="votes-no">NON : ${action.noVotes}</span>
                </div>
                <div class="vote-buttons">
                    <button onclick="vote('${action._id}', 'yes')">Voter OUI</button>
                    <button onclick="vote('${action._id}', 'no')">Voter NON</button>
                </div>
            `;
            activeActionsContainer.prepend(actionCard);
        }

        function updateActionDisplay(action) {
            const actionCard = document.getElementById(`action-${action._id}`);
            if (actionCard) {
                actionCard.querySelector('.votes-yes').innerText = `OUI : ${action.yesVotes}`;
                actionCard.querySelector('.votes-no').innerText = `NON : ${action.noVotes}`;
            }
        }

        function finalizeActionDisplay(result) {
            const actionCard = document.getElementById(`action-${result.actionId}`);
            if (actionCard) {
                actionCard.querySelector('.vote-buttons')?.remove();
                const resultDiv = document.createElement('div');
                resultDiv.className = `result ${result.status}`;
                resultDiv.innerText = result.status === 'success' ? 'R√âUSSIE' : '√âCHOU√âE';
                actionCard.appendChild(resultDiv);
                updateActionDisplay({ _id: result.actionId, yesVotes: result.yes, noVotes: result.no });
                pastActionsContainer.prepend(actionCard); 
                if (activeActionsContainer.children.length === 0) {
                    activeActionsContainer.innerHTML = '<p>Aucune action en cours.</p>';
                }
            }
        }

        function vote(actionId, voteType) {
            socket.emit('vote_action', { actionId: actionId, vote: voteType });
        }

        // √âcouter les changements MetaMask
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    disconnectWalletBtn.click();
                } else if (accounts[0] !== walletAddress) {
                    location.reload(); // Recharger si le compte change
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                if (parseInt(chainId, 16) !== 88882) {
                    alert('‚ö†Ô∏è Vous devez rester sur le testnet Chiliz!');
                    location.reload();
                }
            });
        }
    </script>
</body>
</html>
